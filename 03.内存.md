# 03.å†…å­˜

### æ¦‚è¿°
```text
ä¹¦ä¸­ä¾‹å­ï¼Œå†…å­˜çš„åº•å±‚è®¾å¤‡é€‰ç”¨æ•°æ®è§¦å‘å™¨ï¼ˆDFFï¼‰ï¼Œç°ä»£è®¡ç®—æœºå†…å­˜åº•å±‚è®¾å¤‡ä¸ä¸€å®šæ˜¯DFFï¼Œå¯èƒ½æ˜¯å…¶ä»–ç‹¬æœ‰çš„ç‰©ç†ç‰¹æ€§ã€‚DFFä¹Ÿå¯ä»¥ä»…é€šè¿‡Nandæ„å»ºï¼Œä½†å¾ˆå¤æ‚ï¼Œæ‰€ä»¥ä¹¦ä¸­çš„ä¾‹å­å°†å…¶ä½œä¸ºåŸå§‹é€»è¾‘é—¨ä½¿ç”¨ã€‚å…¶ä½¿ç”¨æ–¹å¼å¦‚ä¸‹å›¾
```
![DFF](img/C551EE00-0EF5-4675-B596-E2D7A465CE21.png)
```text
æ‰€æœ‰å†…å­˜èŠ¯ç‰‡éƒ½å«æ•°æ®è§¦å‘å™¨ï¼ˆDFFï¼‰ã€‚æ‰€æœ‰çš„DFFé€šè¿‡ä¸“ç”¨çš„æ—¶é—´æ€»çº¿åŒæ—¶æ¥æ”¶åˆ°ç”±æŒ¯è¡å™¨å‘å‡ºçš„æ—¶é’Ÿå‘¨æœŸä¿¡å·ï¼ˆtick-tockï¼‰ï¼ŒDFFåœ¨æ¯ä¸ªå‘¨æœŸç»“æŸï¼ˆtockï¼‰æ—¶è¾“å‡ºç»“æŸå‰æ—¶é—´è¿˜å¤„äºå‘¨æœŸå†…ï¼ˆèŒƒå›´ï¼š(ä¸Šä¸€ä¸ªtock, å½“å‰tock) ï¼‰æ—¶çš„è¾“å…¥ã€‚
```
```text
Â· æ—¶åºé€»è¾‘æ—¢ç»“åˆDFFè¾¾åˆ°â€œè®°å¿†/å­˜å‚¨â€çš„æ•ˆæœï¼Œä¹Ÿç”¨äºåŒæ­¥ä¸åŒçš„ç‰©ç†æ—¶å»¶ã€‚å‡å¦‚ALUçš„ä¸¤ä¸ªå…¥å‚åœ¨ä¸åŒæ—¶é—´åˆ°è¾¾ALUï¼Œé‚£ä¹ˆALUå°†è¾“å‡ºé”™è¯¯çš„ç»“æœã€‚æ‰€ä»¥æ—¶é’Ÿå‘¨æœŸåœ¨å¿…é¡»å¤§äºæ•´ä¸ªç¡¬ä»¶æœ€é•¿æ—¶å»¶çš„åŒæ—¶ï¼Œåˆè¦å°½å¯èƒ½çŸ­ï¼Œå‘¨æœŸè¶ŠçŸ­é€Ÿåº¦è¶Šå¿«ã€‚
Â·  è®¿é—®RAMçš„ä¸åŒåœ°å€ï¼Œæ‰€èŠ±æ—¶é—´æ˜¯ç›¸åŒçš„ã€‚
```

<br>
<br>

### ä¹ é¢˜
<hr>
<br>
<br>

![Bit](img/1330F203-6BC5-4C7A-8F1F-A6C541689D69.png)
```text
æŒ‰ç…§å›¾ç¤ºè¿æ¥
Mux(a=dffOut, b=in, sel=load, out=dffIn);
DFF(in=dffIn, out=dffOut, out=out);
```

<br>
<br>
<hr>
<br>
<br>

![Register](img/A30C535D-65A8-41EB-8EB9-89C8B0479D8B.png)
```text
å¦‚æœæœ‰16ä½çš„DFFï¼Œå¯ä»¥åƒBitä¸€æ ·è¿æ¥ã€‚å› ä¸ºæ²¡æœ‰ï¼Œæ‰€ä»¥ä½¿ç”¨16ä¸ªBit
Bit(in = in[0], load = load, out = out[0]);
...
Bit(in = in[15], load = load, out = out[15]);
```

<br>
<br>
<hr>
<br>
<br>

![RAMn](img/855B03EB-6BC3-431D-A931-4CFAEA579063.png)
```text
è¿™ä¸ªnæŒ‡çš„æ˜¯åœ°å€æ•°ï¼Œå°†ä¾æ¬¡å®ç°è¿™äº›næ•°{8, 64, 512, 4K, 16K}ï¼Œå…¶å¯¹åº”çš„addressä½æ•°k={3, 6, 9, 12, 14}ï¼Œåœ°å€ä½æ•°é€’å¢çš„ä¸ªæ•°æœ‰åŠ©äºä½¿ç”¨å·²æ„å»ºå¥½çš„RAM

RAM8
åœ¨è¾“å…¥æ—¶ï¼Œè¦æ ¹æ®3ä½åœ°å€çš„å€¼æ¥é€‰å–8ä¸ªå¯„å­˜å™¨ï¼Œå¯ç”¨8è·¯åˆ†è§£å™¨ã€‚è€Œåœ¨è¾“å‡ºæ—¶ä½¿ç”¨16ä½8è·¯é€‰æ‹©å™¨ã€‚
8è·¯åˆ†è§£å™¨æ˜¯1ä½çš„ï¼Œä¸èƒ½ç”¨æ¥ä¼ é€’inï¼Œä½†å¯ä»¥ç”¨æ¥ä¼ é€’loadï¼Œå®ƒé€‰æ‹©çš„ç»“æœä½œä¸ºå„å¯„å­˜å™¨çš„loadä½ã€‚æ²¡æœ‰è¢«é€‰æ‹©çš„å¯„å­˜å™¨ä¸è¯»å…¥å€¼ï¼Œä½†å®ƒä»¬ä¾æ—§è¾“å‡ºï¼Œæ‰€ä»¥å®ƒä»¬çš„è¾“å‡ºè¿˜è¦ç»è¿‡16ä½8è·¯é€‰æ‹©å™¨ç­›é€‰ã€‚
DMux8Way(in=load, sel=address, a=inR0, b=inR1, c=inR2, d=inR3, e=inR4, f=inR5, g=inR6, h=inR7);
Register(in=in, load=inR0, out=outR0);
Register(in=in, load=inR1, out=outR1);
Register(in=in, load=inR2, out=outR2);
Register(in=in, load=inR3, out=outR3);
Register(in=in, load=inR4, out=outR4);
Register(in=in, load=inR5, out=outR5);
Register(in=in, load=inR6, out=outR6);
Register(in=in, load=inR7, out=outR7);
Mux8Way16(a=outR0, b=outR1, c=outR2, d=outR3, e=outR4, f=outR5, g=outR6, h=outR7, sel=address, out=out);

RAM64
æŠŠRAM8çœ‹æˆæ•´ä½“ä½¿ç”¨ï¼Œç”¨addressçš„é«˜3ä½é€‰æ‹©ä½¿ç”¨å“ªä¸ªRAM8
DMux8Way(in=load, sel=address[3..5], a=inR0, b=inR1, c=inR2, d=inR3, e=inR4, f=inR5, g=inR6, h=inR7);
RAM8(in=in, load=inR0, address=address[0..2], out=outR0);
RAM8(in=in, load=inR1, address=address[0..2], out=outR1);
RAM8(in=in, load=inR2, address=address[0..2], out=outR2);
RAM8(in=in, load=inR3, address=address[0..2], out=outR3);
RAM8(in=in, load=inR4, address=address[0..2], out=outR4);
RAM8(in=in, load=inR5, address=address[0..2], out=outR5);
RAM8(in=in, load=inR6, address=address[0..2], out=outR6);
RAM8(in=in, load=inR7, address=address[0..2], out=outR7);
Mux8Way16(a=outR0, b=outR1, c=outR2, d=outR3, e=outR4, f=outR5, g=outR6, h=outR7, sel=address[3..5], out=out);

RAM512
DMux8Way(in=load, sel=address[6..8], a=inR0, b=inR1, c=inR2, d=inR3, e=inR4, f=inR5, g=inR6, h=inR7);
RAM64(in=in, load=inR0, address=address[0..5], out=outR0);
RAM64(in=in, load=inR1, address=address[0..5], out=outR1);
RAM64(in=in, load=inR2, address=address[0..5], out=outR2);
RAM64(in=in, load=inR3, address=address[0..5], out=outR3);
RAM64(in=in, load=inR4, address=address[0..5], out=outR4);
RAM64(in=in, load=inR5, address=address[0..5], out=outR5);
RAM64(in=in, load=inR6, address=address[0..5], out=outR6);
RAM64(in=in, load=inR7, address=address[0..5], out=outR7);
Mux8Way16(a=outR0, b=outR1, c=outR2, d=outR3, e=outR4, f=outR5, g=outR6, h=outR7, sel=address[6..8], out=out);

RAM4K
DMux8Way(in=load, sel=address[9..11], a=inR0, b=inR1, c=inR2, d=inR3, e=inR4, f=inR5, g=inR6, h=inR7);
RAM512(in=in, load=inR0, address=address[0..8], out=outR0);
RAM512(in=in, load=inR1, address=address[0..8], out=outR1);
RAM512(in=in, load=inR2, address=address[0..8], out=outR2);
RAM512(in=in, load=inR3, address=address[0..8], out=outR3);
RAM512(in=in, load=inR4, address=address[0..8], out=outR4);
RAM512(in=in, load=inR5, address=address[0..8], out=outR5);
RAM512(in=in, load=inR6, address=address[0..8], out=outR6);
RAM512(in=in, load=inR7, address=address[0..8], out=outR7);
Mux8Way16(a=outR0, b=outR1, c=outR2, d=outR3, e=outR4, f=outR5, g=outR6, h=outR7, sel=address[9..11], out=out);

RAM16K
åœ°å€ä½æ•°å¢åŠ äº†2ï¼Œéœ€è¦ç”¨4è·¯çš„åˆ†è§£å™¨å’Œé€‰æ‹©å™¨ï¼Œåˆ†è§£å™¨ä»ä¸º1ä½çš„
DMux4Way(in=load, sel=address[12..13], a=inR0, b=inR1, c=inR2, d=inR3);
RAM4K(in=in, load=inR0, address=address[0..11], out=outR0);
RAM4K(in=in, load=inR1, address=address[0..11], out=outR1);
RAM4K(in=in, load=inR2, address=address[0..11], out=outR2);
RAM4K(in=in, load=inR3, address=address[0..11], out=outR3);
Mux4Way16(a=outR0, b=outR1, c=outR2, d=outR3, sel=address[12..13], out=out);
```

<br>
<br>
<hr>
<br>
<br>

![PC](img/A05C0406-F570-49C0-9053-A21B009E3ABF.png)
```text
elifå’Œelseåªæœ‰åœ¨å‰ç½®æ¡ä»¶ä¸æˆç«‹æ—¶æ‰æ‰§è¡Œ
// reset
Mux16(a=lastRes, b[0..15]=false, sel=reset, out=afterReset);
// load
// !reset && load
Xor(a=reset, b=true, out=notSet);
And(a=notSet, b=load, out=whetherLoad);
Mux16(a=afterReset, b=in, sel=whetherLoad, out=afterLoad);
// inc
// !reset && !load && inc
Xor(a=load, b=true, out=notLoad);
And(a=notSet, b=notLoad, out=notSetNotLoad);
And(a=notSetNotLoad, b=inc, out=whetherInc);
Inc16(in=afterLoad, out=incRes);
Mux16(a=afterLoad, b=incRes, sel=whetherInc, out=waitOut);
// é€šè¿‡å¯„å­˜å™¨æ·»åŠ æ—¶åºé€»è¾‘å’Œå›è·¯åé¦ˆ
Register(in=waitOut, load=true, out=out, out=lastRes);
----------------------------------------------
âš ï¸ä¸Šè¾¹æ˜¯æˆ‘æœ€åˆçš„æƒ³æ³•ï¼Œæ¯ä¸‹ä¸€ä¸ªæ¡ä»¶éƒ½åˆ¤æ–­æ‰€æœ‰å‰ç½®æ¡ä»¶æ˜¯å¦æˆç«‹ï¼Œéå¸¸å†—ä½™å’Œä¸æ˜“æ‰©å±•ï¼Œä¸‹é¢æ˜¯æˆ‘å‚è€ƒçš„https://github.com/woai3c/nand2tetrisçš„ï¼ŒæŒºå¥½ï¼Œå…ˆæ‰§è¡Œæ¡ä»¶åˆ¤æ–­é¡ºåºæœ€æœ«å°¾çš„ï¼Œå¦‚æœå‰ç½®æ¡ä»¶æˆç«‹ï¼Œä»¥å‰ç½®æ¡ä»¶ä¸ºå‡†ğŸ‘
Inc16(in=lastRes, out=incRes);
Mux16(a=lastRes, b=incRes, sel=inc, out=afterInc);
Mux16(a=afterInc, b=in, sel=load, out=afterLoad);
Mux16(a=afterLoad, b[0..15]=false, sel=reset, out=res);
Register(in=res, load=true, out=lastRes, out=out);
```