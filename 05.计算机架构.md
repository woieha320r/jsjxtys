# 05.è®¡ç®—æœºæ¶æ„

### æ¦‚è¿°
```text
Â· ç›®æ ‡ï¼šé›†æˆå·²ç»æ„å»ºå¥½çš„èŠ¯ç‰‡ï¼Œä½¿å…¶å¯è¿è¡Œç¬¬4ç« çš„æœºå™¨è¯­è¨€
Â· æ¶æ„ï¼šCPUï¼ˆALUã€Dã€Aã€PCï¼‰ã€RAMã€ROMï¼ˆä¸èƒ½åŠ¨æ€åŠ è½½ç¨‹åºï¼‰ã€SCREENã€KBD
Â· I/Oé©±åŠ¨çš„ä½œç”¨ï¼šç”±ç¡¬ä»¶å‚å•†æä¾›ï¼Œå°†ç³»ç»Ÿå‘æ¥çš„æŒ‡ä»¤è§£é‡Šä¸ºå¯è¢«è‡ªå·±ç¡¬ä»¶æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œæ¥å£ç”±æ“ä½œç³»ç»Ÿæä¾›ï¼Œæ¥å£çš„å®ç°ç”±å‚å•†å®ç°ã€‚ä»¥æ­¤å±è”½ä¸åŒç¡¬ä»¶çš„æŒ‡ä»¤å·®å¼‚ã€‚
```

<br>

å†¯è¯ºä¾æ›¼é€šç”¨æ¶æ„å›¾
![å†¯è¯ºä¾æ›¼é€šç”¨æ¶æ„å›¾](img/DECCD629-E2F4-4195-9FA0-CE486E1DBD56.png)

<br>
<br>

### ä¹ é¢˜
<hr>
<br>
<br>

![CPU-1](img/1AEBBFFD-F64B-4D82-A701-2C926195C56B.png)
<br>

ä¸€ç§å¯èƒ½çš„å®ç°æ–¹å¼
![CPU-2](img/09AA8DCA-F396-4BED-8590-61E2A4700AB1.png)
<br>

æœ¬ä¾‹æœºå™¨è¯­è¨€çš„è¯­æ³•è®¾è®¡å›¾
![è¯­æ³•è®¾è®¡å›¾](img/2D6B004B-6DE6-4206-A982-BCD26FE46D9D.png)
<br>

```text
Â· å›¾ä¸­çš„cæŒ‡çš„ä¸æ˜¯"æ˜¯å¦cæŒ‡ä»¤"ï¼Œè€Œæ˜¯ä»æŒ‡ä»¤ä¸­æå–çš„æ§åˆ¶ä½ï¼ŒALUçš„c'sä»£è¡¨CæŒ‡ä»¤ä¸­ç”¨ä»¥é€‰æ‹©å‡½æ•°çš„ccccccè¿™6ä½
Â· Aã€Då¯„å­˜å™¨éœ€åˆ†åˆ«ä½¿ç”¨å†…ç½®èŠ¯ç‰‡ï¼šARegisterã€DRegisterã€‚

ï¼ˆç»“åˆè¯­æ³•è®¾è®¡å›¾è§£é‡Šï¼‰
Â· é€šè¿‡æŒ‡ä»¤æœ€é«˜ä½åˆ¤æ–­Aã€CæŒ‡ä»¤ã€‚
    Â· å¯¹äºAæŒ‡ä»¤ï¼Œå°†æ‰€æœ‰ä½ä½ç½®å…¥Aå¯„å­˜å™¨ï¼Œæ‰€æœ‰ä½ä¹Ÿå¯ä»¥ï¼Œå› ä¸ºåªæ”¯æŒæ­£æ•°å¸¸é‡ã€‚
    Â· å¯¹äºCæŒ‡ä»¤ï¼Œ
        Â· é€šè¿‡aåˆ¤æ–­ALUé™¤Då¤–çš„å¦ä¸€ä¸ªè¾“å…¥æ¥è‡ªäºAè¿˜æ˜¯M
        Â· é€šè¿‡ccccccé€‰æ‹©ALUå°†æ‰§è¡Œçš„å‡½æ•°
        Â· é€šè¿‡dddé€‰æ‹©ALUå°†è¾“å…¥åˆ°å“ªä¸ªå¯„å­˜å™¨
        Â· é€šè¿‡jjjå’ŒALUçš„zrã€ngè¾“å‡ºåˆ¤æ–­æ˜¯å¦è·³è½¬ï¼šif jump; then PC=A; else PC++; fi
Â· è§‚å¯Ÿaccccccï¼ŒDã€A/Måˆ†åˆ«ä»¥xã€yä½œä¸ºALUçš„ä¸¤ä¸ªè¾“å…¥ã€‚
Â· ä¸‰ä¸ªå¯„å­˜å™¨çš„loadæ¡ä»¶é€šè¿‡è§‚å¯ŸdddçœŸå€¼è¡¨å¾—å‡ºã€‚

    // æŒ‡ä»¤æ˜¯å¦æ˜¯cæŒ‡ä»¤
    Xor(a=instruction[15], b=false, out=isC);
    Not(in=isC, out=isA);

    // Aå¯„å­˜å™¨
// CæŒ‡ä»¤ä¸‹ï¼Œæ˜¯å¦å°†ALUç»“æœç½®å…¥A
    Mux16(a=instruction, b=aluRes, sel=isC, out=waitInA);
    And(a=instruction[5], b=isC, out=cInA);
// AæŒ‡ä»¤ä¸‹ç›´æ¥ç½®å…¥A
    Or(a=cInA, b=isA, out=inA);
    // è¾“å‡ºaddressM
    ARegister(in=waitInA, load=inA, out=outA, out[0..14]=addressM);

    // ALUé™¤Då¤–çš„å¦ä¸€ä¸ªå¯„å­˜å™¨çš„è¾“å…¥æ¥è‡ªäºAè¿˜æ˜¯M
    Xor(a=instruction[12], b=false, out=whetherFromM);
    And(a=isC, b=whetherFromM, out=fromM);
    Mux16(a=outA, b=inM, sel=fromM, out=fromAM);

    // Då¯„å­˜å™¨
    // CæŒ‡ä»¤ä¸‹ï¼Œæ˜¯å¦å°†ALUç»“æœç½®å…¥D
    And(a=instruction[4], b=isC, out=inD);
    DRegister(in=aluRes, load=inD, out=outD);

    // ALU
    // CæŒ‡ä»¤ï¼ŒALUæ‰æ‰§è¡Œå‡½æ•°ã€‚å¦åˆ™æ‰§è¡Œ000000
    And(a=isC, b=instruction[11], out=isZx);
    And(a=isC, b=instruction[10], out=isNx);
    And(a=isC, b=instruction[9], out=isZy);
    And(a=isC, b=instruction[8], out=isNy);
    And(a=isC, b=instruction[7], out=isF);
    And(a=isC, b=instruction[6], out=isN);
    ALU(x=outD, y=fromAM, zx=isZx, nx=isNx, zy=isZy, ny=isNy, f=isF, no=isN, out=outM, out=aluRes, zr=aluResZr, ng=aluResNg);

    // ALUç»“æœæ˜¯å¦ç½®å…¥M
    // è¾“å‡ºwriteM
    And(a=isC, b=instruction[3], out=writeM);

    // PC
// è·³è½¬
// å…ˆå‡å®šæ˜¯CæŒ‡ä»¤ï¼Œå‡­jjjå’Œç»“æœæ ‡å¿—åˆ¤æ–­æ˜¯å¦è·³è½¬
    // ALUç»“æœ!=0
    Not(in=aluResZr, out=notZr);
    // ALUç»“æœ!<0
    Not(in=aluResNg, out=notNg);
    // >0 ç­‰åŒ !< && !=
    And(a=instruction[0], b=notNg, out=gz1);
    And(a=gz1, b=notZr, out=gz);
    // =0
    And(a=instruction[1], b=aluResZr, out=ez);
    // <0
    And(a=instruction[2], b=aluResNg, out=lz);
    // æ˜¯å¦jump
    Or(a=gz, b=ez, out=jump1);
    Or(a=jump1, b=lz, out=jjjJump);
// æ˜¯cæŒ‡ä»¤å¹¶ä¸”jjjï¼Œæ‰è·³è½¬
    And(a=isC, b=jjjJump, out=toJump);
    PC(in=outA, load=toJump, inc=true, reset=reset, out[0..14]=pc);
```

<br>
<br>
<hr>
<br>
<br>

![Memory](img/1DA1FE96-434E-45D3-9899-E77323EFD8A7.png)

å±å¹•å’Œé”®ç›˜èŠ¯ç‰‡æ˜¯å†…ç½®çš„
![Screen](img/C893CF6E-92D4-4319-88AF-EEA54010520E.png)

![keyboard](img/4066B9A8-A0DF-433C-9DEF-AEE95FDCAA06.png)
```text
åœ°å€(110000000000000, ~)æ— æ•ˆ
åœ°å€110000000000000æ˜¯è®¿é—®Keyboard
åœ°å€[100000000000000, 101111111111111]æ˜¯è®¿é—®Screen
åœ°å€[000000000000000, 100000000000000)æ˜¯è®¿é—®RAM16K
ä»è§„å¾‹æ¥çœ‹ï¼Œå¯é€šè¿‡æœ€é«˜ä¸¤ä½ä½œåŒºåˆ†ï¼Œä½œä¸ºselä¼ å…¥4è·¯16ä½é€‰æ‹©å™¨åšç»“æœé€‰æ‹©ã€‚
åŸæœ¬æˆ‘æ˜¯ç›´æ¥æŠŠramã€screenã€keyboardéƒ½æ‰§è¡Œï¼Œæœ‰loadçš„å°±ç›´æ¥ä¼ loadã€‚çœ‹äº†https://github.com/woai3c/nand2tetrisçš„ï¼Œå‘ç°æ˜¯ç”¨åˆ†è§£å™¨æŠŠæ˜¯å¦loadä¹Ÿåˆ¤æ–­å–½ã€‚é‚£æˆ‘åŸæ¥å†™æ³•çš„é—®é¢˜æ˜¯ï¼šå‡å¦‚load åœ°å€100000000000000ï¼Œé‚£ä¹ˆè™½ç„¶ç¡®å®æ”¹å˜äº†å±å¹•ï¼Œä½†æ˜¯ram[0]çš„å€¼ä¹Ÿè¢«æ”¹å˜äº†ğŸ¤·â€â™‚ï¸ã€‚

And(a=address[14], b=address[13], out=oo);
Or8Way(in=address[5..12], out=hasTrue1);
Or8Way(in[0..4]=address[0..4], in[5..7]=false, out=hasTrue2);
Or(a=hasTrue1, b=hasTrue2, out=hasTrue);
And(a=oo, b=hasTrue, out=errorAccess);

// åˆ¤æ–­ramå’Œscreenæ˜¯å¦åº”è¯¥è¯»å…¥in
DMux4Way(in=load, sel=address[13..14], a=loadRam1, b=loadRam2, c=loadScreen, d=unuse);
Or(a=loadRam1, b=loadRam2, out=loadRam);

// 00............. / 01.............
RAM16K(in=in, load=loadRam, address=address[0..13], out=outRam);
// 10.............
Screen(in=in, load=loadScreen, address=address[0..12], out=outScreen);
// 110000000000000
Keyboard(out=outKey);
// > 110000000000000
Not16(in=true, out=outZero);

// åˆ¤æ–­è¾“å‡ºå“ªä¸ªèŠ¯ç‰‡çš„ç»“æœ
Mux4Way16(a=outRam, b=outRam, c=outScreen, d=outKey, sel=address[13..14], out=waitOut);

// åˆ¤æ–­æ˜¯å¦æ— æ•ˆåœ°å€
Mux16(a=waitOut, b=outZero, sel=errorAccess, out=out);
```

<br>
<br>
<hr>
<br>
<br>

![Computer-1](img/94A40826-19E9-421C-9841-1BA10EABC664.png)
![Computer-2](img/A50184C8-5BFB-4D5F-89F7-DA403B1720FC.png)

ROM32KèŠ¯ç‰‡æ˜¯å†…ç½®çš„
![ROM32K](img/4A9DC8ED-F79D-4067-B7AA-EA8E9133C808.png)

```text
æŒ‰å›¾è¿æ¥
CPU(inM=memoryOut, instruction=romOut, reset=reset, outM=memoryIn, writeM=memoryLoad, addressM=memoryAddress, pc=romAddress);
Memory(in=memoryIn, load=memoryLoad, address=memoryAddress, out=memoryOut);
ROM32K(address=romAddress, out=romOut);
```